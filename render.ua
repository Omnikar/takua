# Experimental!
~ "git: github.com/Omnikar/uiua-math" ~ BoxMuller FFTConvolve

~ "game"
  ~ Board Move Process
  ~ Cap Flat Wall

Tâ€¼ â† &p $"_ took _" ^0 âœnow^1

BoardBase    â† Ã·255[181 139 62]
BoardBorders â† +0.01Black
BoardTrim    â† Ã·255[84 38 18]
Playerâ‚      â† Ã·255[224 220 195]
Playerâ‚‚      â† Ã·255[43 43 41]
# Playerâ‚‚ â† Ã·255[79 56 27]

BoardPadding     â† 0.3
BoardThickness   â† 0.6
BoardBorderWidth â† 0.05
BoardTrimWidth   â† 0.02

FlatWidth     â† 0.7
FlatThickness â† 0.25

ShadowFactor â† 0.5
OffsetFactor â† 0.015

VoxelRes â† 25

ApplyLighting â† (
  âŠ¸â™­Â°â‰â†¯âŸœâ†¯5â‡Œ[0 0 0 1 2]âŠ£âŠ¸Â°â‰
  âœâŠ™(â†™â‚ƒÂ°â‰)Ã—âŒÂ¬Ã—ShadowFactor FFTConvolve~SameÃ·/+
)
HollowChannel â† Ã—<6â…FFTConvolve~Sameâ†¯Ë™â†¯3â‹¯4281360âŠ¸Â±
HollowModel   â† âœ(âŠ£Â°â‰)HollowChannel

BoardModel â† memo(
  âœ(Ã—âŠ™-|â‡¡â…)VoxelResâŠ¸âŠ¸âŠƒÂ¯+BoardPadding
  âŠƒ(Ã—âŠ“âŒŸ><âŠƒÂ¯+Ã·â‚‚BoardBorderWidth :
  | <Ã·â‚‚BoardBorderWidthâŒµ-âŠ¸â…)
  Ã—âŠ“Ë™âŠÃ—Ë™âŠâ†¥
  ËœâŠ[BoardBase BoardBorders]
  âŠ‚BoardBaseâ†¯â…Ã—BoardThickness VoxelRes
  Ã·VoxelResâ†§â‡ŒâŠ¸â‰¡(â‡Œ|â‡Œ)â‡¡âŠ¸â–³â‚ƒ
  âŠšâ‰¥2/+Â°â‰<BoardTrimWidth
  âœâŠ¡â‰¡â‹…BoardTrim
  âœÂ°â‰âŠ‚âŠ™1

  # Coordinate labels
  # TODO: Fix mirrored labels on the back of the board
  CoordLabel â† (
    âŸœlayoutâ…Ã—VoxelRes BoardThickness
    âˆšâ‰¡â†»Â¯âŒŠÃ·â‚‚Ëœ-âŸœ(â§»â‚â¤™â¬š0â†™ËœâŠŸ) VoxelRes
  )
  â‡ŒÂ°â‹•âˆ©âŒŸ+1@aâ‡¡:
  â‰¡â‡Œâˆ©(â‡Œ/â‰¡âŠ‚â‰¡CoordLabel)
  âˆ©(â‰¡âŒâ†˜â…Ã—VoxelRes BoardPadding)
  âŠ“ËœâŠŸâŠ™(â¬š1â†™â‚„BoardBorders)
  âŠ™â—Œâˆ§(â¤¸0_2âŠ¸âœâŠ™âœÂ°â‰-â¬š0Ã—)

  ApplyLighting
  HollowModel
)

BoardIdxModel â† memo(
  âœ(Ã—âŠ™-|â‡¡â…)VoxelResâŠ¸âŠƒÂ¯+BoardPadding
  -â‚Ã·âŠ¸Â±Ëœâ—¿âŠ¸âˆ©+â‚âŒŠ
  â†§âŠ¸â†¥0+â‚ËœâŒâŠ¥Ë™âŠËœâŠŸ
  â†¯+â‚â…Ã—BoardThickness VoxelRes
  HollowChannel
)

RawFlatModel â† (
  âŠ¸â–³ËœâŠPlayerâ‚‚_Playerâ‚â†¥â‚€
  â†¯âŠ‚â…Ã—VoxelRes[FlatThickness.FlatWidth]
  âœÂ°â‰âŠ‚âŠ™1
)

FlatModel â† memo(
  RawFlatModel
  ApplyLighting
  HollowModel
)

WallModel â† memo(
  â¤¸â‚RawFlatModel
  ApplyLighting
  HollowModel
)

CapModel â† memo(
  âŠŸ0â¬š1â†™â‚„ËœâŠPlayerâ‚‚_Playerâ‚â†¥â‚€
  âŒµË™âŠâ„‚-1/2Ã·âŸœâ‡¡ â…Ã—0.9 VoxelRes
  Ã·-1âŸœâ‡¡ â…Ã—0.7 VoxelRes
  [0.4 0.9 1]
  âŠ—1â‰âŠ¸â‰¤âŒŸ
  â¨¬(Ã·4âˆšÂ¬Ë™Ã—-1Ã—4|+0.12Ã—2Ë™Ã—-0.6|0.3)
  âŠâ‡ŒâŠ<
  ApplyLighting
  HollowModel
)

# ? Coord Model SceneModel
PlaceModel â† (
  â…âœÂ°âŠ‚âŠ“(
    Ã—VoxelRes+BoardThicknessÃ—FlatThickness
  | +Ã·â‚‚-â†˜â‚â—¡â‹…â‹…â–³â‚ƒâŸœÃ—VoxelRes+BoardPadding)
  âœâŠ™(â†™âŠ™â†˜)â†¥ âŠ™âŸœâ‚‚(â¬š0âœâŠ™â–³â‚ƒâ†¥+) âŸœâ–³â‚ƒ:
)

# ? Coords Pieces Board
PlacePieces â† âˆ§(PlaceModelâŠ™â¨¬(FlatModel|WallModel|CapModel))âŠ™(-â‚âŠƒâŒµÂ±)

â”Œâ”€â•´Scene
  ~ {
    # Hovering pieces position
    HoverPos
    # Hovering pieces
    Hover
    # The board state to draw
    State
  }

  # ? Move Board
  Call â† (
    New Move!â£(
      0_0 [] âŠ“Â°Uninit Board~State
    | # :Â¤âŠ“Â°Place Board~State
      0_0 [] âœâŠ™(Â°â–¡âŠ¡)âŠ‚âŠ“Â°Place Board~State
    | Move!âŸœâ†“(
      | -/+âŠƒ(Amnts|Num|Orig)
        âœâŠ™âŠ™(Â°â–¡âŠ¡|Board~State)âŠƒâ†™â†˜
      | Â°âŠ¸Num/+âŠ¸Amnts
        ğ„âŒŸProcess~ProcessMove
        :Board~State
      | +Ã—âŠƒ(â§»Amnts|Dir|Orig)
      )
    )
  )

  # Create a voxels model of the scene
  Build â† (
    # Draw normal pieces
    âŸœ(State
      âŸœ(BoardModelâ§»)
      âŸœâŠ¡âŠšâŠ¸â‰ â‚€Â°â‰â¬š0â‰¡â‚€â—‡â‡Œ
      PlacePieces)

    # Draw hover pieces
    âŸœâ†“(
      Â°âŠâ‡ŒHover
    | :HoverPos
    | âŠƒHoverPos State
      â‰¡âŒŸâŠ‚ +2+â—‡â§»âŠ¡
      PlacePieces
    )

    â¬š0âœâŠ™â§»â†¥â…Ã—VoxelRes+Ã—10FlatThickness BoardThickness
  )

  # IdxsVoxels BoardVoxels ? Scene
  IdxsAndBuild â† (
    âŠƒState Build
    â¬š0â†™â—¡â‹…â§»BoardIdxModelâ§»
  )
â””â”€â•´
