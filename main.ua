# Experimental!
I ~ "git: github.com/Marcos-cat/iris"
~ "game"
  ~ Board Move Process
  ~ Cap Flat Wall
~ "render"
  ~ Playerâ‚ Playerâ‚‚
  ~ Scene

Tâ€¼ â† &p $"_ took _" ^0 âœnow^1

VoxelScale â† 2.5
WinSize    â† 700_700

Code â† âŒ…(+@AâŠ¥26|âŒâŠ¥26-@AâŒµ)
# Normalized spherical to rectangular coordinates
SphToRect â† ËœâŠ‚Ã—âœÂ°âŠŸâˆ©Â°âˆ 

# Render voxels and rescale to screen size
# ? Voxels CamPos
MkVoxels â† â–½â‚‚âŠ¢Ã·â–³â‚‚âŠ¸âŠ™WinSize voxels (Scale:VoxelScale) âŠ™(Camera:SphToRect)
Messageâ‚ â† I~Draw~Text White 30 100_100
Messageâ‚‚ â† I~Draw~Text White 30 100_140

â”Œâ”€â•´GameMode
  |Local
  |Online {
    MyColor
    OtherPort
    Tunnel
  }
â””â”€â•´

~GameState {
  ClickMap
  Texture
  Move
  Board
  GameMode
  CamPos â† [Ï€/4 âˆ âˆš2 1]
  # Turn to view; âˆ means present
  PastView â† âˆ
}

RedrawScene â† (
  # If PastView is âˆ, create a scene out of the present
  # Otherwise, make one out of the corresponding past state
  âŠ¸GameState~PastView
  â£(âŠ¸âŠƒGameState~Move GameState~Board Â°âˆ
  | MoveÂ°âŠ¸Board~StateâŠâŠ™(âŠ¸Board~HistoryâŠ¸GameState~Board))

  Scene

  â£(â—¡â‹…GameState~GameMode
    â£(Â°GameMode~Local
      Â°1â—¿â‚‚â†§Board~Turnâ—¡â‹…âŠƒGameState~Board GameState~PastView
    | Â°1GameMode~Online~MyColor)
    âœâŠƒScene~Hover Scene~Stateâˆ©Â¯
  | )

  âˆ©âŒŸMkVoxels Scene~IdxsAndBuild âŠ™âŠ¸GameState~CamPos
  GameState!Â°âŠ¸âŠƒ(ClickMap|I~Texture~Image Texture)
)

HandleCamRotation â† (
  âŠ¸â‰ â‚€/+I~Key~ULDR 0
  â¨¬â—Œ(Ã—I~Window~DtâŠŸÂ¯Â°â„‚
     âœâŠ™GameState~CamPos-
     RedrawScene)
)

HandlePastViewing â† (
  âŠ¸âŒµ-âˆ©I~Key~Pressed @- @=
  â¨¬â—Œ(âŠ™(âŠ¸âŠƒGameState~PastView(Board~Turn GameState~Board)
       â¥â‹….âŠ¸=âˆ)
     â¥â‹…âˆâ¤šâ‰¤â†¥â‚€+
     Â°âŠ¸GameState~PastView
     RedrawScene)
)

HandleBoardClick â† I~Mouse!Pressedâ€¼Left(
  âŠ™âŠ¸GameState~ClickMap
  âŠ¸Â±âŠ¡âŒŠÃ—â—¡â‹…â–³Ã·WinSizeËœâŠŸÂ°â„‚
  â¨¬â—Œ(
    âŠ™âŠ¸âŠƒ(â™­â‚‚â‡¡â–³â—¡â‹…Board~State âŠƒGameState~Move GameState~Board)
    âŠ-â‚
    Move~ClickSquare
  
    # Opponents place each other's flats on the first two moves
    â£(Â°1<2â—¡â‹…Board~Turn
      â£(Â°âŠ¸Move~Place~Piece Â¯1|â‹…Move~UninitâœÂ°Move~Moveâˆ˜)
    | )
  
    Â°âŠ¸âŠƒGameState~Move GameState~Board
    Â°âŠ¸GameState~PastView âˆ
    RedrawScene
  )
)

HandleMoveSubmission â† â£(
  âŠ¸âŠƒGameState~Move GameState~Board
  Process~Validate
  I~Draw~Text White 40 -50_60 WinSize ">"
  I~Key!Pressedâ€¼(
    {Space @\n}
  | â£(â—¡âŠ™â‹…(GameMode~Online~Tunnel GameState~GameMode)
      I~Net~Give â£âœMove~Place~PieceÂ¯âˆ˜
    | )
    Process
    â£(â—¡â‹…GameState~GameMode
      Â°GameMode~Local
      âœBoard~StateÂ¯
    | )
    Move
  )
  Â°âŠ¸âŠƒGameState~Move GameState~Board
| )

HandleWinState â† (
  âŠ¸GameState~Board
  â£(âŸœ(Â°1âŠ¸/â†¥Board~CheckRoadWin)
    â£(â—¡â‹…â‹…GameState~GameModeâ—¿â‚‚Board~Turn
      =GameMode~Online~MyColor
    )â‹…1
    # Bias for the active player in case of a double road
    âœâŠ(+0.1)
  | Â°1âŠ¸/â†¥ Board~CheckFlatWin)
  â£(Messageâ‚ "Draw" Â°1_1
  | âŠ¢â–
    â£(â—¡â‹…âŠƒGameState~GameMode GameState~Board
      Â°GameMode~Local
      â‰ â—¿â‚‚Board~Turn
      {"White wins!" "Black wins!"}
    | {"You win!" "You lose!"})
    Messageâ‚ËœâŠ)
)

HandleActivePlayer â† (
  âŠ¸GameState~GameMode
  â£Â°GameMode~Local(
    â—ŒÂ°.â—¿â‚‚Board~Turnâ—¡â‹…GameState~Board GameMode~Online~MyColor
  )
  HandleBoardClick
  HandleMoveSubmission
)

HandleMultiplayerWait â† (
  âŠ¸GameState~GameMode
  GameMode~Online~Tunnel
  Messageâ‚ "Waiting for opponent..."
  I~Net~Get!(
    Â°âŠ¸GameState~Move
    âœâŠƒ(GameState~Move|GameState~Board)(Move Process)
    RedrawScene
  )
)

DrawPieceCounters â† (
  âŠ¸âŠƒ(
    GameState~GameMode
  | âŠƒGameState~Board GameState~PastView
    Board!âŠƒ(â—¿â‚‚â†§Turn|â£(ËœâŠHistory|State)|NFlats|NCaps))
  â¥Â¯ â£(âŠ“GameMode~Online~MyColorâ—Œ|â—Œ)
  âŸœÂ¯
  âˆ©âŒŸâ‚‚(
    /â—‡âŠ‚â™­ â†¥â‚€
    âŠƒ(âˆŠFlat_Wall|=Cap)
    Ëœâˆ©-âˆ©/+
  )
  Â°â‹•âŠŸâ‚„
  [20_20 20_60 [-55âŠ¢WinSize 20] [-55âŠ¢WinSize 60]]
  â–½2Playerâ‚_Playerâ‚‚ 40
  I~Draw~Text
)

DrawPastMessage â† (
  âŠ¸Â±-âŠ¸â†§âŠ¸âŠƒGameState~PastView(Board~Turn GameState~Board)
  â¨¬â—Œ(âŸœ(â¨¬""@s>1)
     # TODO: Fix this overlapping with "Waiting for opponent..."
     Messageâ‚‚ $"_ move_ ago")
)

â¢â—Œ(&pf "[l]ocal or [o]nline? "
   Â¬âŠƒâˆŠËœâŠ—"lo"âŠ¢&sc)
â¨¬GameMode~Local(
  I~Net~Start LocalPort:+âš‚â‚â‚€â‚€ 8080
  âŠ¸I~Net~Port
  âŸœ(&p $"Your code is _" Code)
  &pf "Enter opponent's code: "
  Â°Code &sc
  âŠƒ>âŸœğ„I~Net~Connect
  GameMode~Online
)

Board 5

â£(Â°â–¡âŠ1&args
  â£(&rs âˆ 0 Â°"--stdin")&fras
  Move~ParsePTN
  â¤™âŠ™âŠ™âˆ˜
  â£(GameMode~Online~MyColor
    â¥âšâ£âœMove~Place~PieceÂ¯âˆ˜
    âˆ§â—‡Process
  | Â°GameMode~Local
    âˆ§â—‡Process
    âœBoard~History(â¥Â¯â—¿â‚‚Â°âŠ)
    âŠ¸Board~Turn
    â¥âœBoard~StateÂ¯
  )
| )

Move

I~Open WinSize "Tak"
I~Window!Â°FPS 30

âŠ™I~Texture~LoadImage âˆ©âŒŸâ†¯ âŸœâŠ‚WinSize 4 0

GameState

RedrawScene

I~Loop!(
  HandleCamRotation

  HandlePastViewing

  â£(HandleWinState
  | HandleActivePlayer
  | HandleMultiplayerWait)

  I~Draw~Background â†¯4 0
  I~Draw~Background âŠ¸GameState~Texture

  DrawPieceCounters

  DrawPastMessage
)

Board~PTNRecord GameState~Board
+â‚Â°âŠâ‰¡Â°âŠŸâ¬š""â†¯âˆ_2
&pâ¬š""/â—‡âŠ‚â‚ƒ@\nâš$"_. _ _"
