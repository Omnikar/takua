# Experimental!
I ~ "git: github.com/Marcos-cat/iris"
~ "game"
  ~ Board Move Process
  ~ Cap Flat Wall
~ "render"
  ~ Playerâ‚ Playerâ‚‚
  ~ Scene

VoxelScale â† 2.5

Tâ€¼ â† &p $"_ took _" ^0 âœnow^1

WinSize â† 700_700
# Render voxels and rescale to screen size
MkVoxels â† â–½â‚‚âŠ¢Ã·â–³â‚‚âŠ¸âŠ™WinSize voxels Scale: VoxelScale

Code â† âŒ…(+@AâŠ¥26|âŒâŠ¥26-@AâŒµ)

â”Œâ”€â•´GameMode
  |Local
  |Online {
    MyColor
    OtherPort
    Tunnel
  }
â””â”€â•´

~GameState {ClickMap Texture Move Board GameMode}

RedrawScene â† (
  SceneâŠ¸âŠƒGameState~Move GameState~Board

  â£(â—¡â‹…GameState~GameMode
    â£(Â°GameMode~Local
      Â°1â—¿â‚‚â§»Board~Historyâ—¡â‹…GameState~Board
    | Â°1GameMode~Online~MyColor)
    âœâŠƒScene~Hover Scene~Stateâˆ©Â¯
  | )

  âˆ©MkVoxels Scene~IdxsAndBuild
  GameState!Â°âŠ¸âŠƒ(ClickMap|I~Texture~Image Texture)
)

HandleBoardClick â† I~Mouse!Pressedâ€¼Left(
  âŠ™âŠ¸GameState~ClickMap
  âŠ¸Â±âŠ¡âŒŠÃ—â—¡â‹…â–³Ã·WinSizeËœâŠŸÂ°â„‚
  â¨¬â—Œ(
    âŠ™âŠ¸âŠƒ(â™­â‚‚â‡¡â–³â—¡â‹…Board~State âŠƒGameState~Move GameState~Board)
    âŠ-â‚
    Move~ClickSquare
  
    # Opponents place each other's flats on the first two moves
    â£(Â°1<2â§»â—¡â‹…Board~History
      â£(Â°âŠ¸Move~Place~Piece Â¯1|â‹…Move~UninitâœÂ°Move~Moveâˆ˜)
    | )
  
    Â°âŠ¸âŠƒGameState~Move GameState~Board
    RedrawScene
  )
)

HandleMoveSubmission â† â£(
  âŠ¸âŠƒGameState~Move GameState~Board
  Process~Validate
  I~Draw~Text White 40 -50_60 WinSize ">"
  I~Key!Pressedâ€¼(
    {Arrow@> Space @\n}
  | â£(â—¡âŠ™â‹…(GameMode~Online~Tunnel GameState~GameMode)
      I~Net~Give â£âœMove~Place~PieceÂ¯âˆ˜
    | )
    Process
    â£(â—¡â‹…GameState~GameMode
      Â°GameMode~Local
      âœBoard~StateÂ¯
    | )
    Move
  )
  Â°âŠ¸âŠƒGameState~Move GameState~Board
| )

DrawPieceCounters â† (
  âŠ¸âŠƒ(
    GameState~GameMode
  | Board!âŠƒ(â—¿â‚‚â§»History|State|NFlats|NCaps)GameState~Board)
  â¥Â¯Ã—â‰GameMode~Local
  âŸœÂ¯
  âˆ©âŒŸâ‚‚(
    â†¥â‚€
    /â—‡âŠ‚â™­
    âŠƒ(âˆŠFlat_Wall|=Cap)
    Ëœâˆ©-âˆ©/+
  )
  Â°â‹•âŠŸâ‚„
  [20_20 20_60 [-55âŠ¢WinSize 20] [-55âŠ¢WinSize 60]]
  â–½2Playerâ‚_Playerâ‚‚ 40
  I~Draw~Text
)

â¢â—Œ(&pf "[l]ocal or [o]nline? "
   Â¬âŠƒâˆŠËœâŠ—"lo"âŠ¢&sc)
â¨¬GameMode~Local(
  I~Net~Start LocalPort:+âš‚â‚â‚€â‚€ 8080
  âŠ¸I~Net~Port
  âŸœ(&p $"Your code is _" Code)
  &pf "Enter opponent's code: "
  Â°Code &sc
  âŠƒ>âŸœğ„I~Net~Connect
  GameMode~Online
)

Board 5
Move

I~Open WinSize "Tak"
I~Window!Â°FPS 30

âŠ™I~Texture~LoadImage âˆ©MkVoxels Scene~IdxsAndBuildâ—¡Scene

GameState

I~Loop!(
  âŠ¸GameState~GameMode
  â£(â£Â°GameMode~Local(
      â—ŒÂ°.â—¿â‚‚â§»Board~Historyâ—¡â‹…GameState~Board GameMode~Online~MyColor
    )
    HandleBoardClick
    HandleMoveSubmission
  | ËœâŠPlayerâ‚‚_Playerâ‚ GameMode~Online~MyColor
    I~Draw~Text âŠ™(30 100_100 "Waiting for opponent...")
    GameMode~Online~TunnelâŠ¸GameState~GameMode
    I~Net~Get!(
      Â°âŠ¸GameState~Move
      âœâŠƒ(GameState~Move|GameState~Board)(Move Process)
      RedrawScene
    )
  )

  I~Draw~Background â†¯4 0
  I~Draw~Background âŠ¸GameState~Texture

  DrawPieceCounters
)

âŠƒGameState~GameMode(âŠ‚Board!âŠƒHistory State GameState~Board)
â‰¡&s â¥(â¥Â¯â—¿â‚‚Â°âŠ) â‰GameMode~Local
