# Experimental!
I ~ "git: github.com/Marcos-cat/iris"
~ "game"
  ~ Board Move Process
  ~ Cap Flat Wall
~ "render"
  ~ Playerâ‚ Playerâ‚‚
  ~ Scene

Tâ€¼ â† &p $"_ took _" ^0 âœnow^1

VoxelScale â† 2.5
WinSize    â† 700_700

Code â† âŒ…(+@AâŠ¥26|âŒâŠ¥26-@AâŒµ)
# Normalized spherical to rectangular coordinates
SphToRect â† ËœâŠ‚Ã—âœÂ°âŠŸâˆ©Â°âˆ 

# Render voxels and rescale to screen size
# ? Voxels CamPos
MkVoxels â† â–½â‚‚âŠ¢Ã·â–³â‚‚âŠ¸âŠ™WinSize voxels (Scale:VoxelScale) âŠ™(Camera:SphToRect)
Messageâ‚ â† I~Draw~Text White 30 100_100
Messageâ‚‚ â† I~Draw~Text White 30 100_140

â”Œâ”€â•´Chat
  â”Œâ”€â•´Message
    ~ {Sender Time Content}
    Fmt â† âŠ‚ â¨¬â‹…""â¨¬"You: " "Them: " Â±âŠƒ(Time|Sender|Content)
  â””â”€â•´

  ~ {
    History â† Â°â–³âŠŸ0â§»Message~Fields
    Draft â† ""
    Focused â† 0
  }
  Size â† 20
  Draw â† âŸœâ†“(
    History
  | âŠ‚Message .0 ËœâŠ‚@_Draft
    â‰¡âŠŸ30 Ëœ-âŠ£WinSize +40 Ã—SizeÂ°âŠ
  | Â¬Focused
    â¨¬1(Ëœ-nowâ—¡â‹…â‰¡Message~Time
       Â¬â†¥0Ã·4-8 âˆ©â‚ƒâŒâ–½âŠ¸<12
    )
    âŠ™âŠ™âšMessage~Fmt
    I~Draw~Text â‰¡âŒâŠ‚White âŠ™Size
  )
â””â”€â•´

â”Œâ”€â•´GameMode
  |Local
  |Online {
    MyColor
    Tunnel
    Chat â† Chat
  }
â””â”€â•´

~GameState {
  ClickMap
  Texture
  Move
  Board
  GameMode
  CamPos â† [5Ï€/4 âˆ âˆš2 1]
  # Turn to view; âˆ means present
  PastView â† âˆ
}

â”Œâ”€â•´NetMessage
  |JoinRequest {MyPort}
  |JoinAccept {BoardSize YourColor PTN}
  |MakeMove {Move}
  |ChatMessage {Message}
â””â”€â•´

RedrawScene â† (
  # If PastView is âˆ, create a scene out of the present
  # Otherwise, make one out of the corresponding past state
  âŠ¸GameState~PastView
  â£(âŠ¸âŠƒGameState~Move GameState~Board Â°âˆ
  | MoveÂ°âŠ¸Board~StateâŠâŠ™(âŠ¸Board~HistoryâŠ¸GameState~Board))

  Scene

  âˆ©âŒŸMkVoxels Scene~IdxsAndBuild âŠ™âŠ¸GameState~CamPos
  GameState!Â°âŠ¸âŠƒ(ClickMap|I~Texture~Image Texture)
)

HandleCamRotation â† (
  âŠ¸â‰ â‚€/+I~Key~ULDR 0
  â¨¬â—Œ(Ã—I~Window~DtâŠŸÂ¯Â°â„‚
     âœâŠ™GameState~CamPos-
     RedrawScene)
)

HandlePastViewing â† (
  âŠ¸âŒµ-âˆ©I~Key~Pressed @- @=
  â¨¬â—Œ(âŠ™(âŠ¸âŠƒGameState~PastView(Board~Turn GameState~Board)
       â¥â‹….âŠ¸=âˆ)
     â¥â‹…âˆâ¤šâ‰¤â†¥â‚€+
     Â°âŠ¸GameState~PastView
     RedrawScene)
)

HandleBoardClick â† I~Mouse!Pressedâ€¼Left(
  âŠ™âŠ¸GameState~ClickMap
  âŠ¸Â±âŠ¡âŒŠÃ—â—¡â‹…â–³Ã·WinSizeËœâŠŸÂ°â„‚
  â¨¬â—Œ(
    âŠ™âŠ¸âŠƒ(â™­â‚‚â‡¡â–³â—¡â‹…Board~State âŠƒGameState~Move GameState~Board)
    âŠ-â‚
    Move~ClickSquare
  
    Â°âŠ¸âŠƒGameState~Move GameState~Board
    Â°âŠ¸GameState~PastView âˆ
    RedrawScene
  )
)

HandleMoveSubmission â† â£(
  âŠ¸âŠƒGameState~Move GameState~Board
  Process~Validate
  I~Draw~Text White 40 -50_60 WinSize ">"
  I~Key!Pressedâ€¼Space(
    â£(â—¡âŠ™â‹…(GameMode~Online~Tunnel GameState~GameMode)
      NetMessage~MakeMove
      I~Net~Give
    | )
    Process
    Move
  )
  Â°âŠ¸âŠƒGameState~Move GameState~Board
| )

HandleWinState â† (
  âŠ¸GameState~Board
  â£(âŸœ(Â°1âŠ¸/â†¥Board~CheckRoadWin)
    # Bias for the player that was just active in case of a double road
    âœâŠ(+0.1) Â¬Board~ActivePlayer
  | Â°1âŠ¸/â†¥Board~CheckFlatWin)
  # Don't draw the game end message if viewing a past move
  â£(Â°1â‰ âˆâ‹…âŠ¸GameState~PastView
  | Messageâ‚ "Draw" Â°1_1
  | âŠ¢â–
    â£(=GameMode~Online~MyColorâ—¡â‹…GameState~GameMode
      {"You lose!" "You win!"}
    | {"White wins!" "Black wins!"})
    Messageâ‚ ËœâŠ
  )
)

CheckActivePlayer â† (
  âŠ¸GameState~GameMode
  â£Â°GameMode~Local(
    â—ŒÂ°.Board~ActivePlayerâ—¡â‹…GameState~Board GameMode~Online~MyColor
  )
)

HandleActivePlayer â† (
  CheckActivePlayer
  HandleBoardClick
  HandleMoveSubmission
)

HandleMultiplayerWait â† (
  âŠ¸GameState~GameMode
  GameMode~Online~Tunnel
  I~Net~Get!â£(
    Â°NetMessage~MakeMove
    Â°âŠ¸GameState~Move
    âœâŠƒ(GameState~Move|GameState~Board)(Move Process)
    RedrawScene
  | Â°NetMessage~ChatMessage
    âœChat~Message~SenderÂ¬
    âœâŠ™(Chat~History GameMode~Online~Chat GameState~GameMode)âŠ‚
  )
)

HandleChatInteraction â† (
  I~Mouse~Pressedâ€¼I~Mouse~Leftâ‹…â£(Â°âŠ¸(Chat~Focused GameMode~Online~Chat GameState~GameMode)0|)

  â£(GameMode~Online~Chat âŠ¸GameState~GameMode
    Â°1 âŠ¸Chat~Focused
    I~Key~Pressed @\n
    â¨¬(âœChat~Draft (â–½âŠ¸â‰  @\t I~Key~Input)
    | âŠ¸Chat~Draft
      Â±âŠ¸â§»
      â¨¬â—Œ(
        Chat~Message 0 now
        âŸœâœâŠ™Chat~HistoryâŠ‚
        NetMessage~ChatMessage
        âŠ™â—¡â‹…(GameMode~Online~Tunnel GameState~GameMode)
        I~Net~Give
        Â°âŠ¸Chat~Draft ""
      )
      Â°âŠ¸Chat~Focused 0
    )
    Â°âŠ¸(GameMode~Online~Chat GameState~GameMode)
  | I~Key~Pressedâ€¼@\n(Â°âŠ¸(Chat~Focused GameMode~Online~Chat GameState~GameMode) 1)
  | )

  â£(I~Key~Pressedâ€¼@\tâœ(Chat~Focused GameMode~Online~Chat GameState~GameMode)Â¬
    Chat~Draw GameMode~Online~ChatâŠ¸GameState~GameMode
  | )
)

DrawPieceCounters â† (
  âŠ¸âŠƒGameState~Board GameState~PastView
  Board!âŠƒ(â£(ËœâŠHistory|State)|NFlats|NCaps)
  âŸœÂ¯
  âˆ©âŒŸâ‚‚(
    /â—‡âŠ‚â™­ â†¥â‚€
    âŠƒ(âˆŠFlat_Wall|=Cap)
    Ëœâˆ©-âˆ©/+
  )
  Â°â‹•âŠŸâ‚„
  [20_20 20_60 [-55âŠ¢WinSize 20] [-55âŠ¢WinSize 60]]
  â–½2Playerâ‚_Playerâ‚‚ 40
  I~Draw~Text
)

DrawPastMessage â† (
  âŠ¸Â±-âŠ¸â†§âŠ¸âŠƒGameState~PastView(Board~Turn GameState~Board)
  â¨¬â—Œ(âŸœ(â¨¬""@s>1)
     # TODO: Fix this overlapping with "Waiting for opponent..."
     Messageâ‚‚ $"_ move_ ago")
)

DrawBeginningMessage = (
  <2 Board~Turn byGameState~Board
  rep(Message,1 "Place your opponent's piece")
)

ExportPTN â† (
  Board~PTNRecordâŠ¸GameState~Board
  +â‚Â°âŠâ‰¡Â°âŠŸâ¬š""â†¯âˆ_2
  â¬š""/â—‡âŠ‚â‚ƒ@\nâš$"_. _ _"
)

QueryBoardSize â† (
  &pf "Enter board size (5): "
  â£(âˆ©Â°1âŠ¸âŠƒâ‰¥â‚„â‰¤â‚ˆâ‹•)5 &sc
)

QueryMyColor â† (
  &pf "Player [1] or player [2] (random)? "
  â£(-â‚Â°1âŠ¸âˆŠ1_2â‹•|â…âš‚) &sc
)

LoadPTN â† (memoâ£(
    Â°â–¡âŠ1&args
    â£(&rs âˆ 0 &p"Enter PTN:" Â°"--stdin")&fras
    Move~ParsePTN
  ){})

â¢â—Œ(&pf "[l]ocal or [o]nline? "
   Â¬âŠƒâˆŠËœâŠ—"lo"â¬š@.âŠ¢&sc)
â¨¬(Board QueryBoardSize GameMode~Local
  âˆ§â—‡Process LoadPTN
| I~Net~Start LocalPort:+âš‚â‚â‚€â‚€ 8080
  â¢â—Œ(&pf "[h]ost or [j]oin? "
     Â¬âŠƒâˆŠËœâŠ—"hj"â¬š@.âŠ¢&sc)
  â¨¬(âŠ™(:LoadPTN QueryMyColor QueryBoardSize)
    âŠ¸I~Net~Port
    &p $"Your code is _" Code
    &p "Waiting for opponent to join..."
    NetMessage~JoinAcceptâ—¡â‹…(ğ„âŒŸ:Â¬)
    :âŠ™â†“(
      Board
    | | âˆ§â—‡Process
    | Â°NetMessage~JoinRequestâŠ¸(I~Net~Get Block:1)
      &p "Connected"
      I~Net~Connect
    | âŠ¸I~Net~Give
      ËœGameMode~Online)
  | &pf "Enter host's code: "
    Â°Code &sc
    I~Net~Portâ¤™I~Net~Connect
    NetMessage~JoinRequest
    âŠ¸I~Net~Give
    âŸœ(I~Net~Get Block:1)
    âŠ™NetMessage~JoinAccept!âŸœâ†“(
      Board BoardSize
    | âˆ§â—‡Process PTN
    | YourColor
    )
    :ËœGameMode~Online
  )
)

Move

I~Open WinSize "Tak"
I~Window!Â°FPS 30

âŠ™I~Texture~LoadImage âˆ©âŒŸâ†¯ âŸœâŠ‚WinSize 4 0

GameState

RedrawScene

I~Loop!(
  I~Draw~Background â†¯4 0
  I~Draw~Background âŠ¸GameState~Texture

  HandleCamRotation

  HandlePastViewing

  I~Key~Pressedâ€¼@e(&p ExportPTN)

  HandleChatInteraction

  â£(HandleWinState
  | â£(CheckActivePlayer
      DrawBeginningMessage
      |Messageâ‚ "Waiting for opponent...")
    Â°0 â£(Chat~Focused GameMode~Online~ChatâŠ¸GameState~GameMode)0
    HandleActivePlayer
  | )

  â£(HandleMultiplayerWait|)

  DrawPieceCounters

  DrawPastMessage
)

&p ExportPTN

âŸœâ†“(
  I~Texture~Unload GameState~Texture
| â£(I~Net~End GameMode~Online~Tunnel GameState~GameMode|))
